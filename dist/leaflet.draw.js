/*
 Copyright (c) 2012, Smartrak, Jacob Toye
 Leaflet.draw is an open-source JavaScript library for drawing shapes/markers on leaflet powered maps.
 https://github.com/jacobtoye/Leaflet.draw
*/
(function(e,t){L.drawVersion="0.1.6",L.LatLngUtil={cloneLatLngs:function(e){var t=[];for(var n=0,r=e.length;n<r;n++)t.push(this.cloneLatLng(e[n]));return t},cloneLatLng:function(e){return L.latLng(e.lat,e.lng)}},L.Util.extend(L.LineUtil,{segmentsIntersect:function(e,t,n,r){return this._checkCounterclockwise(e,n,r)!==this._checkCounterclockwise(t,n,r)&&this._checkCounterclockwise(e,t,n)!==this._checkCounterclockwise(e,t,r)},_checkCounterclockwise:function(e,t,n){return(n.y-e.y)*(t.x-e.x)>(t.y-e.y)*(n.x-e.x)}}),L.Polyline.include({intersects:function(){var e=this._originalPoints,t=e?e.length:0,n,r,i,s,o,u;if(this._tooFewPointsForIntersection())return!1;for(n=t-1;n>=3;n--){i=e[n-1],s=e[n];if(this._lineSegmentsIntersectsRange(i,s,n-2))return!0}return!1},newLatLngIntersects:function(e,t){return this._map?this.newPointIntersects(this._map.latLngToLayerPoint(e),t):!1},newPointIntersects:function(e,t){var n=this._originalPoints,r=n?n.length:0,i=n?n[r-1]:null,s=r-2;return this._tooFewPointsForIntersection(1)?!1:this._lineSegmentsIntersectsRange(i,e,s,t?1:0)},_tooFewPointsForIntersection:function(e){var t=this._originalPoints,n=t?t.length:0;return n+=e||0,!this._originalPoints||n<=3},_lineSegmentsIntersectsRange:function(e,t,n,r){var i=this._originalPoints,s,o;r=r||0;for(var u=n;u>r;u--){s=i[u-1],o=i[u];if(L.LineUtil.segmentsIntersect(e,t,s,o))return!0}return!1}}),L.Polygon.include({intersects:function(){var e,t=this._originalPoints,n,r,i,s;return this._tooFewPointsForIntersection()?!1:(e=L.Polyline.prototype.intersects.call(this),e?!0:(n=t.length,r=t[0],i=t[n-1],s=n-2,this._lineSegmentsIntersectsRange(i,r,s,1)))}}),L.Draw={},L.Draw.Feature=L.Handler.extend({includes:L.Mixin.Events,initialize:function(e,t){this._map=e,this._container=e._container,this._overlayPane=e._panes.overlayPane,this._popupPane=e._panes.popupPane,t&&t.shapeOptions&&(t.shapeOptions=L.Util.extend({},this.options.shapeOptions,t.shapeOptions)),L.Util.extend(this.options,t)},enable:function(){if(this._enabled)return;this.fire("enabled",{handler:this.type}),this._map.fire("draw:enabled",{drawingType:this.type}),L.Handler.prototype.enable.call(this)},disable:function(){if(!this._enabled)return;this.fire("disabled",{handler:this.type}),this._map.fire("draw:disabled",{drawingType:this.type}),L.Handler.prototype.disable.call(this)},addHooks:function(){this._map&&(L.DomUtil.disableTextSelection(),this._tooltip=new L.Tooltip(this._map),L.DomEvent.addListener(this._container,"keyup",this._cancelDrawing,this))},removeHooks:function(){this._map&&(L.DomUtil.enableTextSelection(),this._tooltip.dispose(),this._tooltip=null,L.DomEvent.removeListener(this._container,"keyup",this._cancelDrawing))},_fireCreatedEvent:function(e){this._map.fire("draw:created",{layer:e,layerType:this.type})},_cancelDrawing:function(e){e.keyCode===27&&this.disable()}}),L.Draw.Polyline=L.Draw.Feature.extend({statics:{TYPE:"polyline"},Poly:L.Polyline,options:{allowIntersection:!0,drawError:{color:"#b00b00",message:"<strong>Error:</strong> shape edges cannot cross!",timeout:2500},icon:new L.DivIcon({iconSize:new L.Point(8,8),className:"leaflet-div-icon leaflet-editing-icon"}),guidelineDistance:20,shapeOptions:{stroke:!0,color:"#f06eaa",weight:4,opacity:.5,fill:!1,clickable:!0},zIndexOffset:2e3},initialize:function(e,t){t&&t.drawError&&(t.drawError=L.Util.extend({},this.options.drawError,t.drawError)),this.type=L.Draw.Polyline.TYPE,L.Draw.Feature.prototype.initialize.call(this,e,t)},addHooks:function(){L.Draw.Feature.prototype.addHooks.call(this),this._map&&(this._markers=[],this._markerGroup=new L.LayerGroup,this._map.addLayer(this._markerGroup),this._poly=new L.Polyline([],this.options.shapeOptions),this._tooltip.updateContent(this._getTooltipText()),this._mouseMarker||(this._mouseMarker=L.marker(this._map.getCenter(),{icon:L.divIcon({className:"leaflet-mouse-marker",iconAnchor:[20,20],iconSize:[40,40]}),opacity:0,zIndexOffset:this.options.zIndexOffset})),this._mouseMarker.on("click",this._onClick,this).addTo(this._map),this._map.on("mousemove",this._onMouseMove,this).on("zoomend",this._onZoomEnd,this))},removeHooks:function(){L.Draw.Feature.prototype.removeHooks.call(this),this._clearHideErrorTimeout(),this._cleanUpShape(),this._map.removeLayer(this._markerGroup),delete this._markerGroup,delete this._markers,this._map.removeLayer(this._poly),delete this._poly,this._mouseMarker.off("click",this._onClick),this._map.removeLayer(this._mouseMarker),delete this._mouseMarker,this._clearGuides(),this._map.off("mousemove",this._onMouseMove).off("zoomend",this._onZoomEnd)},_finishShape:function(){var e=this._poly.newLatLngIntersects(this._poly.getLatLngs()[0],!0);if(!this.options.allowIntersection&&e||!this._shapeIsValid()){this._showErrorTooltip();return}this._fireCreatedEvent(),this.disable()},_shapeIsValid:function(){return!0},_onZoomEnd:function(e){this._updateGuide()},_onMouseMove:function(e){var t=e.layerPoint,n=e.latlng,r=this._markers.length;this._currentLatLng=n,this._tooltip.updatePosition(n),this._updateGuide(t),this._mouseMarker.setLatLng(n),L.DomEvent.preventDefault(e.originalEvent)},_onClick:function(e){var t=e.target.getLatLng(),n=this._markers.length;if(n>0&&!this.options.allowIntersection&&this._poly.newLatLngIntersects(t)){this._showErrorTooltip();return}this._errorShown&&this._hideErrorTooltip(),this._markers.push(this._createMarker(t)),this._poly.addLatLng(t),this._poly.getLatLngs().length===2&&this._map.addLayer(this._poly),this._updateMarkerHandler(),this._vertexAdded(t),this._clearGuides()},_updateMarkerHandler:function(){this._markers.length>1&&this._markers[this._markers.length-1].on("click",this._finishShape,this),this._markers.length>2&&this._markers[this._markers.length-2].off("click",this._finishShape)},_createMarker:function(e){var t=new L.Marker(e,{icon:this.options.icon,zIndexOffset:this.options.zIndexOffset*2});return this._markerGroup.addLayer(t),t},_updateGuide:function(e){e=e||this._map.latLngToLayerPoint(this._currentLatLng);var t=this._markers.length;t>0&&(this._errorShown||this._tooltip.updateContent(this._getTooltipText()),this._clearGuides(),this._drawGuide(this._map.latLngToLayerPoint(this._markers[t-1].getLatLng()),e))},_drawGuide:function(e,t){var n=Math.floor(Math.sqrt(Math.pow(t.x-e.x,2)+Math.pow(t.y-e.y,2))),r,i,s,o;this._guidesContainer||(this._guidesContainer=L.DomUtil.create("div","leaflet-draw-guides",this._overlayPane));for(r=this.options.guidelineDistance;r<n;r+=this.options.guidelineDistance)i=r/n,s={x:Math.floor(e.x*(1-i)+i*t.x),y:Math.floor(e.y*(1-i)+i*t.y)},o=L.DomUtil.create("div","leaflet-draw-guide-dash",this._guidesContainer),o.style.backgroundColor=this._errorShown?this.options.drawError.color:this.options.shapeOptions.color,L.DomUtil.setPosition(o,s)},_updateGuideColor:function(e){if(this._guidesContainer)for(var t=0,n=this._guidesContainer.childNodes.length;t<n;t++)this._guidesContainer.childNodes[t].style.backgroundColor=e},_clearGuides:function(){if(this._guidesContainer)while(this._guidesContainer.firstChild)this._guidesContainer.removeChild(this._guidesContainer.firstChild)},_getTooltipText:function(){var e,t,n;return this._markers.length===0?e={text:"Click to start drawing line."}:(t=this._measurementRunningTotal+this._currentLatLng.distanceTo(this._markers[this._markers.length-1].getLatLng()),n=t>1e3?(t/1e3).toFixed(2)+" km":Math.ceil(t)+" m",this._markers.length===1?e={text:"Click to continue drawing line.",subtext:n}:e={text:"Click last point to finish line.",subtext:n}),e},_showErrorTooltip:function(){this._errorShown=!0,this._tooltip.showAsError().updateContent({text:this.options.drawError.message}),this._updateGuideColor(this.options.drawError.color),this._poly.setStyle({color:this.options.drawError.color}),this._clearHideErrorTimeout(),this._hideErrorTimeout=setTimeout(L.Util.bind(this._hideErrorTooltip,this),this.options.drawError.timeout)},_hideErrorTooltip:function(){this._errorShown=!1,this._clearHideErrorTimeout(),this._tooltip.removeError().updateContent(this._getTooltipText()),this._updateGuideColor(this.options.shapeOptions.color),this._poly.setStyle({color:this.options.shapeOptions.color})},_clearHideErrorTimeout:function(){this._hideErrorTimeout&&(clearTimeout(this._hideErrorTimeout),this._hideErrorTimeout=null)},_vertexAdded:function(e){this._markers.length===1?this._measurementRunningTotal=0:this._measurementRunningTotal+=e.distanceTo(this._markers[this._markers.length-2].getLatLng())},_cleanUpShape:function(){this._markers.length>0&&this._markers[this._markers.length-1].off("click",this._finishShape)},_fireCreatedEvent:function(){var e=new this.Poly(this._poly.getLatLngs(),this.options.shapeOptions);L.Draw.Feature.prototype._fireCreatedEvent.call(this,e)}}),L.Draw.Polygon=L.Draw.Polyline.extend({statics:{TYPE:"polygon"},Poly:L.Polygon,options:{shapeOptions:{stroke:!0,color:"#f06eaa",weight:4,opacity:.5,fill:!0,fillColor:null,fillOpacity:.2,clickable:!0}},initialize:function(e,t){L.Draw.Polyline.prototype.initialize.call(this,e,t),this.type=L.Draw.Polygon.TYPE},_updateMarkerHandler:function(){this._markers.length===1&&this._markers[0].on("click",this._finishShape,this)},_getTooltipText:function(){var e;return this._markers.length===0?e="Click to start drawing shape.":this._markers.length<3?e="Click to continue drawing shape.":e="Click first point to close this shape.",{text:e}},_shapeIsValid:function(){return this._markers.length>=3},_vertexAdded:function(e){},_cleanUpShape:function(){this._markers.length>0&&this._markers[0].off("click",this._finishShape)}}),L.SimpleShape={},L.Draw.SimpleShape=L.Draw.Feature.extend({addHooks:function(){L.Draw.Feature.prototype.addHooks.call(this),this._map&&(this._map.dragging.disable(),this._container.style.cursor="crosshair",this._tooltip.updateContent({text:this._initialLabelText}),this._map.on("mousedown",this._onMouseDown,this).on("mousemove",this._onMouseMove,this))},removeHooks:function(){L.Draw.Feature.prototype.removeHooks.call(this),this._map&&(this._map.dragging.enable(),this._container.style.cursor="",this._map.off("mousedown",this._onMouseDown,this).off("mousemove",this._onMouseMove,this),L.DomEvent.off(document,"mouseup",this._onMouseUp),this._shape&&(this._map.removeLayer(this._shape),delete this._shape)),this._isDrawing=!1},_onMouseDown:function(e){this._isDrawing=!0,this._startLatLng=e.latlng,L.DomEvent.on(document,"mouseup",this._onMouseUp,this).preventDefault(e.originalEvent)},_onMouseMove:function(e){var t=e.latlng;this._tooltip.updatePosition(t),this._isDrawing&&(this._tooltip.updateContent({text:"Release mouse to finish drawing."}),this._drawShape(t))},_onMouseUp:function(e){this._shape&&this._fireCreatedEvent(),this.disable()}}),L.Draw.Rectangle=L.Draw.SimpleShape.extend({statics:{TYPE:"rectangle"},options:{shapeOptions:{stroke:!0,color:"#f06eaa",weight:4,opacity:.5,fill:!0,fillColor:null,fillOpacity:.2,clickable:!0}},initialize:function(e,t){this.type=L.Draw.Rectangle.TYPE,L.Draw.SimpleShape.prototype.initialize.call(this,e,t)},_initialLabelText:"Click and drag to draw rectangle.",_drawShape:function(e){this._shape?this._shape.setBounds(new L.LatLngBounds(this._startLatLng,e)):(this._shape=new L.Rectangle(new L.LatLngBounds(this._startLatLng,e),this.options.shapeOptions),this._map.addLayer(this._shape))},_fireCreatedEvent:function(){var e=new L.Rectangle(this._shape.getBounds(),this.options.shapeOptions);L.Draw.SimpleShape.prototype._fireCreatedEvent.call(this,e)}}),L.Draw.Circle=L.Draw.SimpleShape.extend({statics:{TYPE:"circle"},options:{shapeOptions:{stroke:!0,color:"#f06eaa",weight:4,opacity:.5,fill:!0,fillColor:null,fillOpacity:.2,clickable:!0}},initialize:function(e,t){this.type=L.Draw.Circle.TYPE,L.Draw.SimpleShape.prototype.initialize.call(this,e,t)},_initialLabelText:"Click and drag to draw circle.",_drawShape:function(e){this._shape?this._shape.setRadius(this._startLatLng.distanceTo(e)):(this._shape=new L.Circle(this._startLatLng,this._startLatLng.distanceTo(e),this.options.shapeOptions),this._map.addLayer(this._shape))},_fireCreatedEvent:function(){var e=new L.Circle(this._startLatLng,this._shape.getRadius(),this.options.shapeOptions);L.Draw.SimpleShape.prototype._fireCreatedEvent.call(this,e)}}),L.Draw.Marker=L.Draw.Feature.extend({statics:{TYPE:"marker"},options:{icon:new L.Icon.Default,zIndexOffset:2e3},initialize:function(e,t){this.type=L.Draw.Marker.TYPE,L.Draw.Feature.prototype.initialize.call(this,e,t)},addHooks:function(){L.Draw.Feature.prototype.addHooks.call(this),this._map&&(this._tooltip.updateContent({text:"Click map to place marker."}),this._map.on("mousemove",this._onMouseMove,this))},removeHooks:function(){L.Draw.Feature.prototype.removeHooks.call(this),this._map&&(this._marker&&(this._marker.off("click",this._onClick),this._map.off("click",this._onClick).removeLayer(this._marker),delete this._marker),this._map.off("mousemove",this._onMouseMove))},_onMouseMove:function(e){var t=e.latlng;this._tooltip.updatePosition(t),this._marker?this._marker.setLatLng(t):(this._marker=new L.Marker(t,{icon:this.options.icon,zIndexOffset:this.options.zIndexOffset}),this._marker.on("click",this._onClick,this),this._map.on("click",this._onClick,this).addLayer(this._marker))},_onClick:function(e){this._fireCreatedEvent(),this.disable()},_fireCreatedEvent:function(){var e=new L.Marker(this._marker.getLatLng(),{icon:this.options.icon});L.Draw.Feature.prototype._fireCreatedEvent.call(this,e)}}),L.Edit=L.Edit||{},L.Edit.SimpleShape=L.Handler.extend({options:{moveIcon:new L.DivIcon({iconSize:new L.Point(8,8),className:"leaflet-div-icon leaflet-editing-icon leaflet-edit-move"}),resizeIcon:new L.DivIcon({iconSize:new L.Point(8,8),className:"leaflet-div-icon leaflet-editing-icon leaflet-edit-resize"})},initialize:function(e,t){this._shape=e,L.Util.setOptions(this,t)},addHooks:function(){this._shape._map&&(this._map=this._shape._map,this._markerGroup||this._initMarkers(),this._map.addLayer(this._markerGroup))},removeHooks:function(){if(this._shape._map){this._unbindMarker(this._moveMarker);for(var e=0,t=this._resizeMarkers.length;e<t;e++)this._unbindMarker(this._resizeMarkers[e]);this._resizeMarkers=null,this._map.removeLayer(this._markerGroup),delete this._markerGroup}this._map=null},updateMarkers:function(){this._markerGroup.clearLayers(),this._initMarkers()},_initMarkers:function(){this._markerGroup||(this._markerGroup=new L.LayerGroup),this._createMoveMarker(),this._createResizeMarker()},_createMoveMarker:function(){},_createResizeMarker:function(){},_createMarker:function(e,t){var n=new L.Marker(e,{draggable:!0,icon:t,zIndexOffset:10});return this._bindMarker(n),this._markerGroup.addLayer(n),n},_bindMarker:function(e){e.on("dragstart",this._onMarkerDragStart,this).on("drag",this._onMarkerDrag,this).on("dragend",this._onMarkerDragEnd,this)},_unbindMarker:function(e){e.off("dragstart",this._onMarkerDragStart).off("drag",this._onMarkerDrag).off("dragend",this._onMarkerDragEnd)},_onMarkerDragStart:function(e){var t=e.target;t.setOpacity(0)},_onMarkerDrag:function(e){var t=e.target,n=t.getLatLng();t===this._moveMarker?this._move(n):this._resize(n),this._shape.redraw()},_onMarkerDragEnd:function(e){var t=e.target;t.setOpacity(1),this._shape.fire("edit")},_move:function(e){},_resize:function(e){}}),L.Edit=L.Edit||{},L.Edit.Rectangle=L.Edit.SimpleShape.extend({_createMoveMarker:function(){var e=this._shape.getBounds(),t=e.getCenter();this._moveMarker=this._createMarker(t,this.options.moveIcon)},_createResizeMarker:function(){var e=this._getCorners();this._resizeMarkers=[];for(var t=0,n=e.length;t<n;t++)this._resizeMarkers.push(this._createMarker(e[t],this.options.resizeIcon)),this._resizeMarkers[t]._cornerIndex=t},_onMarkerDragStart:function(e){L.Edit.SimpleShape.prototype._onMarkerDragStart.call(this,e);var t=this._getCorners(),n=e.target,r=n._cornerIndex;this._oppositeCorner=t[(r+2)%4],this._toggleCornerMarkers(0,r)},_onMarkerDragEnd:function(e){var t=e.target,n,r;t===this._moveMarker&&(n=this._shape.getBounds(),r=n.getCenter(),t.setLatLng(r)),this._toggleCornerMarkers(1),this._repositionCornerMarkers(),L.Edit.SimpleShape.prototype._onMarkerDragEnd.call(this,e)},_move:function(e){var t=this._shape.getLatLngs(),n=this._shape.getBounds(),r=n.getCenter(),i,s=[];for(var o=0,u=t.length;o<u;o++)i=[t[o].lat-r.lat,t[o].lng-r.lng],s.push([e.lat+i[0],e.lng+i[1]]);this._shape.setLatLngs(s),this._repositionCornerMarkers()},_resize:function(e){var t;this._shape.setBounds(L.latLngBounds(e,this._oppositeCorner)),t=this._shape.getBounds(),this._moveMarker.setLatLng(t.getCenter())},_getCorners:function(){var e=this._shape.getBounds(),t=e.getNorthWest(),n=e.getNorthEast(),r=e.getSouthEast(),i=e.getSouthWest();return[t,n,r,i]},_toggleCornerMarkers:function(e){for(var t=0,n=this._resizeMarkers.length;t<n;t++)this._resizeMarkers[t].setOpacity(e)},_repositionCornerMarkers:function(){var e=this._getCorners();for(var t=0,n=this._resizeMarkers.length;t<n;t++)this._resizeMarkers[t].setLatLng(e[t])}}),L.Rectangle.addInitHook(function(){L.Edit.Rectangle&&(this.editing=new L.Edit.Rectangle(this),this.options.editable&&this.editing.enable())}),L.Edit=L.Edit||{},L.Edit.Circle=L.Edit.SimpleShape.extend({_createMoveMarker:function(){var e=this._shape.getLatLng();this._moveMarker=this._createMarker(e,this.options.moveIcon)},_createResizeMarker:function(){var e=this._shape.getLatLng(),t=this._getResizeMarkerPoint(e);this._resizeMarkers=[],this._resizeMarkers.push(this._createMarker(t,this.options.resizeIcon))},_getResizeMarkerPoint:function(e){var t=this._shape._radius*Math.cos(Math.PI/4),n=this._map.project(e);return this._map.unproject([n.x+t,n.y-t])},_move:function(e){var t=this._getResizeMarkerPoint(e);this._resizeMarkers[0].setLatLng(t),this._shape.setLatLng(e)},_resize:function(e){var t=this._moveMarker.getLatLng(),n=t.distanceTo(e);this._shape.setRadius(n)}}),L.Circle.addInitHook(function(){L.Edit.Circle&&(this.editing=new L.Edit.Circle(this),this.options.editable&&this.editing.enable()),this.on("add",function(){this.editing&&this.editing.enabled()&&this.editing.addHooks()}),this.on("remove",function(){this.editing&&this.editing.enabled()&&this.editing.removeHooks()})}),L.Control.Draw=L.Control.extend({options:{position:"topleft",draw:{},edit:!1},initialize:function(e){L.Control.prototype.initialize.call(this,e);var t,n;this._toolbars={},this.options.draw&&(n=new L.DrawToolbar(this.options.draw),t=L.stamp(n),this._toolbars[t]=n,this._toolbars[t].on("enable",this._toolbarEnabled,this)),this.options.edit&&(n=new L.EditToolbar(this.options.edit),t=L.stamp(n),this._toolbars[t]=n,this._toolbars[t].on("enable",this._toolbarEnabled,this))},onAdd:function(e){var t=L.DomUtil.create("div","leaflet-draw"),n=!1,r="leaflet-draw-toolbar-top",i;for(var s in this._toolbars)this._toolbars.hasOwnProperty(s)&&(i=this._toolbars[s].addToolbar(e),n||(L.DomUtil.hasClass(i,r)||L.DomUtil.addClass(i.childNodes[0],r),n=!0),t.appendChild(i));return t},onRemove:function(e){for(var t in this._toolbars)this._toolbars.hasOwnProperty(t)&&this._toolbars[t].removeToolbar()},_toolbarEnabled:function(e){var t=""+L.stamp(e.target);for(var n in this._toolbars)this._toolbars.hasOwnProperty(n)&&n!==t&&this._toolbars[n].disable()}}),L.Map.mergeOptions({drawControl:!1}),L.Map.addInitHook(function(){this.options.drawControl&&(this.drawControl=new L.Control.Draw,this.addControl(this.drawControl))}),L.Toolbar=L.Class.extend({includes:[L.Mixin.Events],initialize:function(e){L.setOptions(this,e),this._modes={},this._actionButtons=[],this._activeMode=null},enabled:function(){return this._activeMode!==null},disable:function(){if(!this.enabled())return;this._activeMode.handler.disable()},removeToolbar:function(){for(var e in this._modes)this._modes.hasOwnProperty(e)&&(this._disposeButton(this._modes[e].button,this._modes[e].handler.enable),this._modes[e].handler.disable(),this._modes[e].handler.off("enabled",this._handlerActivated).off("disabled",this._handlerDeactivated));this._modes={};for(var t=0,n=this._actionButtons.length;t<n;t++)this._disposeButton(this._actionButtons[t]);this._actionButtons=[],this._actionsContainer=null},_initModeHandler:function(e,t,n,r){var i=e.type;this._modes[i]={},this._modes[i].handler=e,this._modes[i].button=this._createButton({title:this.options[i].title,className:r+"-"+i,container:t,callback:this._modes[i].handler.enable,context:this._modes[i].handler}),this._modes[i].buttonIndex=n,this._modes[i].handler.on("enabled",this._handlerActivated,this).on("disabled",this._handlerDeactivated,this)},_createButton:function(e){var t=L.DomUtil.create("a",e.className||"",e.container);return t.href="#",e.text&&(t.innerHTML=e.text),e.title&&(t.title=e.title),L.DomEvent.on(t,"click",L.DomEvent.stopPropagation).on(t,"mousedown",L.DomEvent.stopPropagation).on(t,"dblclick",L.DomEvent.stopPropagation).on(t,"click",L.DomEvent.preventDefault).on(t,"click",e.callback,e.context),t},_disposeButton:function(e,t){L.DomEvent.off(e,"click",L.DomEvent.stopPropagation).off(e,"mousedown",L.DomEvent.stopPropagation).off(e,"dblclick",L.DomEvent.stopPropagation).off(e,"click",L.DomEvent.preventDefault).off(e,"click",t)},_handlerActivated:function(e){this._activeMode&&this._activeMode.handler.enabled()&&this._activeMode.handler.disable(),this._activeMode=this._modes[e.handler],L.DomUtil.addClass(this._activeMode.button,"leaflet-draw-toolbar-button-enabled"),this._showActionsToolbar(),this.fire("enable")},_handlerDeactivated:function(e){this._hideActionsToolbar(),L.DomUtil.removeClass(this._activeMode.button,"leaflet-draw-toolbar-button-enabled"),this._activeMode=null,this.fire("disable")},_createActions:function(e){var t=L.DomUtil.create("ul","leaflet-draw-actions"),n=50,r=e.length,i=r*n+(r-1),s,o;for(var u=0;u<r;u++)s=L.DomUtil.create("li","",t),o=this._createButton({title:e[u].title,text:e[u].text,container:s,callback:e[u].callback,context:e[u].context}),this._actionButtons.push(o);return t.style.width=i+"px",t},_showActionsToolbar:function(){var e=this._activeMode.buttonIndex,t=this._lastButtonIndex,n=26,r=1,i=e*n+e*r-1;this._actionsContainer.style.top=i+"px",e===0&&(L.DomUtil.addClass(this._toolbarContainer,"leaflet-draw-toolbar-notop"),L.DomUtil.addClass(this._actionsContainer,"leaflet-draw-actions-top")),e===t&&(L.DomUtil.addClass(this._toolbarContainer,"leaflet-draw-toolbar-nobottom"),L.DomUtil.addClass(this._actionsContainer,"leaflet-draw-actions-bottom")),this._actionsContainer.style.display="block"},_hideActionsToolbar:function(){this._actionsContainer.style.display="none",L.DomUtil.removeClass(this._toolbarContainer,"leaflet-draw-toolbar-notop"),L.DomUtil.removeClass(this._toolbarContainer,"leaflet-draw-toolbar-nobottom"),L.DomUtil.removeClass(this._actionsContainer,"leaflet-draw-actions-top"),L.DomUtil.removeClass(this._actionsContainer,"leaflet-draw-actions-bottom")}}),L.Tooltip=L.Class.extend({initialize:function(e){this._map=e,this._popupPane=e._panes.popupPane,this._container=L.DomUtil.create("div","leaflet-draw-tooltip",this._popupPane),this._singleLineLabel=!1},dispose:function(){this._popupPane.removeChild(this._container),this._container=null},updateContent:function(e){return e.subtext=e.subtext||"",e.subtext.length===0&&!this._singleLineLabel?(L.DomUtil.addClass(this._container,"leaflet-draw-tooltip-single"),this._singleLineLabel=!0):e.subtext.length>0&&this._singleLineLabel&&(L.DomUtil.removeClass(this._container,"leaflet-draw-tooltip-single"),this._singleLineLabel=!1),this._container.innerHTML=(e.subtext.length>0?'<span class="leaflet-draw-tooltip-subtext">'+e.subtext+"</span>"+"<br />":"")+"<span>"+e.text+"</span>",this},updatePosition:function(e){var t=this._map.latLngToLayerPoint(e);return L.DomUtil.setPosition(this._container,t),this},showAsError:function(){return L.DomUtil.addClass(this._container,"leaflet-error-draw-tooltip"),this},removeError:function(){return L.DomUtil.removeClass(this._container,"leaflet-error-draw-tooltip"),this}}),L.DrawToolbar=L.Toolbar.extend({options:{polyline:{title:"Draw a polyline"},polygon:{title:"Draw a polygon"},rectangle:{title:"Draw a rectangle"},circle:{title:"Draw a circle"},marker:{title:"Add a marker"}},initialize:function(e){L.Toolbar.prototype.initialize.call(this,e)},addToolbar:function(e){var t=L.DomUtil.create("div","leaflet-draw-section"),n=0,r="leaflet-draw-draw";return this._toolbarContainer=L.DomUtil.create("div","leaflet-draw-toolbar leaflet-bar"),this.options.polyline&&this._initModeHandler(new L.Draw.Polyline(e,this.options.polyline),this._toolbarContainer,n++,r),this.options.polygon&&this._initModeHandler(new L.Draw.Polygon(e,this.options.polygon),this._toolbarContainer,n++,r),this.options.rectangle&&this._initModeHandler(new L.Draw.Rectangle(e,this.options.rectangle),this._toolbarContainer,n++,r),this.options.circle&&this._initModeHandler(new L.Draw.Circle(e,this.options.circle),this._toolbarContainer,n++,r),this.options.marker&&this._initModeHandler(new L.Draw.Marker(e,this.options.marker),this._toolbarContainer,n++,r),this._lastButtonIndex=--n,this._actionsContainer=this._createActions([{title:"Cancel drawing",text:"Cancel",callback:this.disable,context:this}]),t.appendChild(this._toolbarContainer),t.appendChild(this._actionsContainer),t}}),L.EditToolbar=L.Toolbar.extend({options:{edit:{title:"Edit layers"},remove:{title:"Delete layers"},featureGroup:null,selectedPathOptions:null},initialize:function(e){L.Toolbar.prototype.initialize.call(this,e),this._selectedFeatureCount=0},addToolbar:function(e){var t=L.DomUtil.create("div","leaflet-draw-section"),n=0,r="leaflet-draw-edit";return this._toolbarContainer=L.DomUtil.create("div","leaflet-draw-toolbar leaflet-bar"),this._map=e,this.options.edit&&this._initModeHandler(new L.EditToolbar.Edit(e,{featureGroup:this.options.featureGroup,selectedPathOptions:this.options.selectedPathOptions}),this._toolbarContainer,n++,r),this.options.remove&&this._initModeHandler(new L.EditToolbar.Delete(e,{featureGroup:this.options.featureGroup}),this._toolbarContainer,n++,r),this._lastButtonIndex=--n,this._actionsContainer=this._createActions([{title:"Save changes.",text:"Save",callback:this._save,context:this},{title:"Cancel editing, discards all changes.",text:"Cancel",callback:this.disable,context:this}]),t.appendChild(this._toolbarContainer),t.appendChild(this._actionsContainer),t},disable:function(){if(!this.enabled())return;this._activeMode.handler.revertLayers(),L.Toolbar.prototype.disable.call(this)},_save:function(){this._activeMode.handler.disable()}}),L.EditToolbar.Edit=L.Handler.extend({statics:{TYPE:"edit"},includes:L.Mixin.Events,options:{selectedPathOptions:{color:"#fe57a1",opacity:.6,dashArray:"10, 10",fill:!0,fillColor:"#fe57a1",fillOpacity:.1}},initialize:function(e,t){L.Handler.prototype.initialize.call(this,e),t.selectedPathOptions=t.selectedPathOptions||this.options.selectedPathOptions,L.Util.setOptions(this,t),this._featureGroup=this.options.featureGroup;if(!(this._featureGroup instanceof L.FeatureGroup))throw Error("options.featureGroup must be a L.FeatureGroup");this._uneditedLayerProps={},this.type=L.EditToolbar.Edit.TYPE},enable:function(){if(this._enabled)return;L.Handler.prototype.enable.call(this),this._featureGroup.on("layeradd",this._enableLayerEdit,this).on("layerremove",this._disableLayerEdit,this),this.fire("enabled",{handler:this.type})},disable:function(){if(!this._enabled)return;this.fire("disabled",{handler:this.type}),this._featureGroup.off("layeradd",this._enableLayerEdit).off("layerremove",this._disableLayerEdit),L.Handler.prototype.disable.call(this)},addHooks:function(){this._map&&(this._featureGroup.eachLayer(this._enableLayerEdit,this),this._tooltip=new L.Tooltip(this._map),this._tooltip.updateContent({text:"Drag handles, or marker to edit feature.",subtext:"Click cancel to undo changes."}),this._map.on("mousemove",this._onMouseMove,this))},removeHooks:function(){this._map&&(this._featureGroup.eachLayer(this._disableLayerEdit,this),this._uneditedLayerProps={},this._tooltip.dispose(),this._tooltip=null,this._map.off("mousemove",this._onMouseMove))},revertLayers:function(){this._featureGroup.eachLayer(function(e){this._revertLayer(e)},this)},_backupLayer:function(e){var t=L.Util.stamp(e),n;this._uneditedLayerProps[t]||(e instanceof L.Polyline||e instanceof L.Polygon||e instanceof L.Rectangle?this._uneditedLayerProps[t]={latlngs:L.LatLngUtil.cloneLatLngs(e.getLatLngs())}:e instanceof L.Circle?this._uneditedLayerProps[t]={latlng:L.LatLngUtil.cloneLatLng(e.getLatLng()),radius:e.getRadius()}:this._uneditedLayerProps[t]={latlng:L.LatLngUtil.cloneLatLng(e.getLatLng())})},_revertLayer:function(e){var t=L.Util.stamp(e);this._uneditedLayerProps.hasOwnProperty(t)&&(e instanceof L.Polyline||e instanceof L.Polygon||e instanceof L.Rectangle?e.setLatLngs(this._uneditedLayerProps[t].latlngs):e instanceof L.Circle?(e.setLatLng(this._uneditedLayerProps[t].latlng),e.setRadius(this._uneditedLayerProps[t].radius)):e.setLatLng(this._uneditedLayerProps[t].latlng))},_toggleMarkerHighlight:function(e){var t=e._icon;t.style.display="none",L.DomUtil.hasClass(t,"leaflet-edit-marker-selected")?(L.DomUtil.removeClass(t,"leaflet-edit-marker-selected"),this._offsetMarker(t,-4)):(L.DomUtil.addClass(t,"leaflet-edit-marker-selected"),this._offsetMarker(t,4)),t.style.display=""},_offsetMarker:function(e,t){var n=parseInt(e.style.marginTop,10)-t,r=parseInt(e.style.marginLeft,10)-t;e.style.marginTop=n+"px",e.style.marginLeft=r+"px"},_enableLayerEdit:function(e){var t=e.layer||e.target||e,n=L.Util.extend({},this.options.selectedPathOptions);this._backupLayer(t),t instanceof L.Marker?this._toggleMarkerHighlight(t):(t.options.previousOptions=t.options,!(t instanceof L.Circle)&&!(t instanceof L.Polygon)&&!(t instanceof L.Rectangle)&&(n.fill=!1),t.setStyle(n)),t instanceof L.Marker?t.dragging.enable():t.editing.enable()},_disableLayerEdit:function(e){var t=e.layer||e.target||e;t instanceof L.Marker?this._toggleMarkerHighlight(t):(t.setStyle(t.options.previousOptions),delete t.options.previousOptions),t instanceof L.Marker?t.dragging.disable():t.editing.disable()},_onMouseMove:function(e){this._tooltip.updatePosition(e.latlng)}}),L.EditToolbar.Delete=L.Handler.extend({statics:{TYPE:"remove"},includes:L.Mixin.Events,initialize:function(e,t){L.Handler.prototype.initialize.call(this,e),L.Util.setOptions(this,t),this._deletableLayers=this.options.featureGroup;if(!(this._deletableLayers instanceof L.FeatureGroup))throw Error("options.featureGroup must be a L.FeatureGroup");this.type=L.EditToolbar.Delete.TYPE},enable:function(){if(this._enabled)return;L.Handler.prototype.enable.call(this),this._deletableLayers.on("layeradd",this._enableLayerDelete,this).on("layerremove",this._disableLayerDelete,this),this.fire("enabled",{handler:this.type})},disable:function(e){if(!this._enabled)return;L.Handler.prototype.disable.call(this),this._deletableLayers.off("layeradd",this._enableLayerDelete).off("layerremove",this._disableLayerDelete),this.fire("disabled",{handler:this.type})},addHooks:function(){this._map&&(this._deletableLayers.eachLayer(this._enableLayerDelete,this),this._deletedLayers=new L.layerGroup,this._tooltip=new L.Tooltip(this._map),this._tooltip.updateContent({text:"Click on a feature to remove."}),this._map.on("mousemove",this._onMouseMove,this))},removeHooks:function(){this._map&&(this._deletableLayers.eachLayer(this._disableLayerDelete,this),this._deletedLayers=null,this._tooltip.dispose(),this._tooltip=null,this._map.off("mousemove",this._onMouseMove))},revertLayers:function(){this._deletedLayers.eachLayer(function(e){this._deletableLayers.addLayer(e)},this)},_enableLayerDelete:function(e){var t=e.layer||e.target||e;t.on("click",this._removeLayer,this)},_disableLayerDelete:function(e){var t=e.layer||e.target||e;t.off("click",this._removeLayer),this._deletedLayers.removeLayer(t)},_removeLayer:function(e){var t=e.layer||e.target||e;this._deletableLayers.removeLayer(t),this._deletedLayers.addLayer(t)},_onMouseMove:function(e){this._tooltip.updatePosition(e.latlng)}})})(this);